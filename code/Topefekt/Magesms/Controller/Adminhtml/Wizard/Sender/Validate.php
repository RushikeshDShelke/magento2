<?php
/**
 * Mage SMS - SMS notification & SMS marketing
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the BSD 3-Clause License
 * It is available through the world-wide-web at this URL:
 * http://opensource.org/licenses/BSD-3-Clause
 *
 * @category    TOPefekt
 * @package     TOPefekt_Magesms
 * @copyright   Copyright (c) 2012-2017 TOPefekt s.r.o. (http://www.mage-sms.com)
 * @license     http://opensource.org/licenses/BSD-3-Clause
 */
 namespace Topefekt\Magesms\Controller\Adminhtml\Wizard\Sender; use Magento\Backend\App\Action\Context; use Magento\Framework\App\ObjectManager; use Magento\Framework\DataObject; use Magento\Framework\Registry; use Magento\Framework\View\Result\PageFactory; use Magento\Framework\Controller\Result\JsonFactory; use Topefekt\Magesms\Helper\Data; use Topefekt\Magesms\Model\Api; use Topefekt\Magesms\Model\CountryFactory; use Topefekt\Magesms\Model\Ownnumbersender; use Topefekt\Magesms\Model\Routes; use Topefekt\Magesms\Model\Sms; use Topefekt\Magesms\Model\Smshistory; use Topefekt\Magesms\Model\Smsprofile; use Topefekt\Magesms\Model\Textsender; class Validate extends \Topefekt\Magesms\Controller\Adminhtml\Wizard { protected $resultJsonFactory; public function __construct(Context $i31cc913adc2717e2346d503153c97449098831aa, PageFactory $i3f1db03e4dfdd28ff5ba1a1f709c3a2e135b99b1, Smsprofile $i6abff7c4dab2aa28578ae1dc49699ba6b1d18c18, Api $i451f679eaafeecb81387b150019f0d9e0fa83d16, Data $i0d09b2a4f282150bf47b02f9f3d82586fe313844, Registry $ie9fe5cdc9fc7093987f4d41ad4cae3554e64e17b, CountryFactory $i037b855bc01175f2c77d5c3e19eda9a0003feff4, Routes $ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec, Ownnumbersender $i1ad1e2c93d17b0cc1f975eb7f24bf76446264c6f, Textsender $i340682ca0ed5a64e8ea449191da847abaf0aec6f, JsonFactory $i62e47f1622e42a21f634db5e492d7fe7f7a85d54) { parent::__construct($i31cc913adc2717e2346d503153c97449098831aa, $i3f1db03e4dfdd28ff5ba1a1f709c3a2e135b99b1, $i6abff7c4dab2aa28578ae1dc49699ba6b1d18c18, $i451f679eaafeecb81387b150019f0d9e0fa83d16, $i0d09b2a4f282150bf47b02f9f3d82586fe313844, $ie9fe5cdc9fc7093987f4d41ad4cae3554e64e17b, $i037b855bc01175f2c77d5c3e19eda9a0003feff4, $ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec, $i1ad1e2c93d17b0cc1f975eb7f24bf76446264c6f, $i340682ca0ed5a64e8ea449191da847abaf0aec6f); $this->resultJsonFactory = $i62e47f1622e42a21f634db5e492d7fe7f7a85d54; } public function execute() { $i91f38bff7110fc85a77a8fd1a2cbfe902aa46e9e = ObjectManager::getInstance(); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e = new DataObject(); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(false); if (!$this->getRequest()->getPost()) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(true); return $this->resultJsonFactory->create()->setData($ia1a238c1f12f3901520c7ca55efa646e471f7f6e); } $ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec = $this->getRoutes(); $ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec->setData($this->getSession()->getRoutes()); if ($ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec->displayCode !== true) { $i1b3f50fe6674f47cc7c1967f93ff153879178f04 = trim(($i51c6d8e5b3a92b4b73711680253408ec6d3d25f6 = $this->getRequest()->getParam('sender')) ? $i51c6d8e5b3a92b4b73711680253408ec6d3d25f6 : $this->getRequest()->getParam('newsender')); $ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec->setSenderId($i1b3f50fe6674f47cc7c1967f93ff153879178f04); } else { $id3e549697752385571e09ffe4add9278d2d6923b = $this->getRequest()->getParam('code'); $i1b3f50fe6674f47cc7c1967f93ff153879178f04 = $ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec->getSenderId(); } $ibdd27a8dd714410289189d318feb96fe6ed8e07f = $ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec->validate(); if (is_array($ibdd27a8dd714410289189d318feb96fe6ed8e07f)) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(true); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setMessage(implode(' ', $ibdd27a8dd714410289189d318feb96fe6ed8e07f)); return $this->resultJsonFactory->create()->setData($ia1a238c1f12f3901520c7ca55efa646e471f7f6e); } $i75cfaf6baf7d451ab67af9aeef048aecfea24a82 = $i91f38bff7110fc85a77a8fd1a2cbfe902aa46e9e->create(\Magento\Framework\DB\Transaction::class); $i75cfaf6baf7d451ab67af9aeef048aecfea24a82->addObject($ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec); if ($ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec->getSendertype() == $ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec::SENDER_OWN) { $i451f679eaafeecb81387b150019f0d9e0fa83d16 = $this->getApi(); if ($ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec->displayCode !== true) { $ie2dfb7828566af8f72c6f2bf370ed8614bf010ab = __('Confirmation code: '); $i74c7f58458d186850e8386ae20067ea0a7958311 = $ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec->getGate($i1b3f50fe6674f47cc7c1967f93ff153879178f04, 'admin'); $i9e1925546463c5a41ccbc625ed973556cc86a495 = ''; $ia61712c27ea241bd7a543dc2b02ea572274d0322 = 'action=checksenderID&text_sms='.urlencode($ie2dfb7828566af8f72c6f2bf370ed8614bf010ab).'&username='.urlencode($this->profile->user->getUser()). '&password='.urlencode($this->profile->user->getPasswd()).'&senderID='.urlencode($i1b3f50fe6674f47cc7c1967f93ff153879178f04).$i9e1925546463c5a41ccbc625ed973556cc86a495; $ia61712c27ea241bd7a543dc2b02ea572274d0322 = $i451f679eaafeecb81387b150019f0d9e0fa83d16->serverPost($ia61712c27ea241bd7a543dc2b02ea572274d0322); if (in_array($ia61712c27ea241bd7a543dc2b02ea572274d0322['errno'], [1, 11])) { $i5ee2fa256ff77dd811a9c1911f7563263a694e4b = $i91f38bff7110fc85a77a8fd1a2cbfe902aa46e9e->create(Smshistory::class); $i5ee2fa256ff77dd811a9c1911f7563263a694e4b->setNumber('+'.$i1b3f50fe6674f47cc7c1967f93ff153879178f04); $i5ee2fa256ff77dd811a9c1911f7563263a694e4b->setDate(date('Y-m-d h:i:s', time())); $i5ee2fa256ff77dd811a9c1911f7563263a694e4b->setText($ie2dfb7828566af8f72c6f2bf370ed8614bf010ab); $i5ee2fa256ff77dd811a9c1911f7563263a694e4b->setStatus(1); list($ie10d5ed46013be2962a9d08e0e1912a9c56891b4, $i58457975a91d59a84d2920953badcb7365ac1f01, $if928b7780c12c52495a2f84d8c183269cfcb7c63) = explode("__", $ia61712c27ea241bd7a543dc2b02ea572274d0322['datasrc']); $i5ee2fa256ff77dd811a9c1911f7563263a694e4b->setPrice($i58457975a91d59a84d2920953badcb7365ac1f01); $i5ee2fa256ff77dd811a9c1911f7563263a694e4b->setCredit($if928b7780c12c52495a2f84d8c183269cfcb7c63); $i5ee2fa256ff77dd811a9c1911f7563263a694e4b->setSender($i74c7f58458d186850e8386ae20067ea0a7958311->getSenderId()); $i5ee2fa256ff77dd811a9c1911f7563263a694e4b->setUnicode(0); $i5ee2fa256ff77dd811a9c1911f7563263a694e4b->setType(Sms::TYPE_ADMIN); $i5ee2fa256ff77dd811a9c1911f7563263a694e4b->setSmsid($ie10d5ed46013be2962a9d08e0e1912a9c56891b4); $i5ee2fa256ff77dd811a9c1911f7563263a694e4b->setTotal(1); $i5ee2fa256ff77dd811a9c1911f7563263a694e4b->save(); $ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec->displayCode = true; $this->getSession()->setRoutes($ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec->getData()); } elseif ($ia61712c27ea241bd7a543dc2b02ea572274d0322['errno'] == 111) { } /* elseif ($ia61712c27ea241bd7a543dc2b02ea572274d0322['errno'] == 3 && $ia61712c27ea241bd7a543dc2b02ea572274d0322['error'] == 9) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setMessage(__('error - wrong number or unavailable')); } */ elseif ($ia61712c27ea241bd7a543dc2b02ea572274d0322['errno'] == 3 && $ia61712c27ea241bd7a543dc2b02ea572274d0322['error'] == 10) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setMessage(__('error - low credit for sending validation SMS')); } elseif ($ia61712c27ea241bd7a543dc2b02ea572274d0322['errno'] == 3 && $ia61712c27ea241bd7a543dc2b02ea572274d0322['error'] == 15) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setMessage(__('error - unauthorized senderID in confirmation sms')); } elseif ($ia61712c27ea241bd7a543dc2b02ea572274d0322['errno'] == 3) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setMessage(__('error - '.$ia61712c27ea241bd7a543dc2b02ea572274d0322['error'])); } elseif ($ia61712c27ea241bd7a543dc2b02ea572274d0322['errno'] == 4) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setMessage(__('login error')); } else { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setMessage(__('can not connect to SMS server').' '.$ia61712c27ea241bd7a543dc2b02ea572274d0322['error']); } } else { $ia61712c27ea241bd7a543dc2b02ea572274d0322 = 'action=checksenderIDcode&username='.urlencode($this->profile->user->getUser()).'&password='.urlencode($this->profile->user->getPasswd()). '&code='.urlencode($id3e549697752385571e09ffe4add9278d2d6923b).'&senderID='.urlencode($ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec->getSenderId()); $ia61712c27ea241bd7a543dc2b02ea572274d0322 = $i451f679eaafeecb81387b150019f0d9e0fa83d16->serverPost($ia61712c27ea241bd7a543dc2b02ea572274d0322); if ($ia61712c27ea241bd7a543dc2b02ea572274d0322['errno'] == 1) { $ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec->displayCode = false; } elseif ($ia61712c27ea241bd7a543dc2b02ea572274d0322['errno'] == 3) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setMessage(__('error - ').$ia61712c27ea241bd7a543dc2b02ea572274d0322['error']); } elseif ($ia61712c27ea241bd7a543dc2b02ea572274d0322['errno'] == 4) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setMessage(__('login error')); } elseif ($ia61712c27ea241bd7a543dc2b02ea572274d0322['errno'] == 5) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setMessage(__('correctly confirm sms code')); } else { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setMessage(__('can not connect to SMS server')); } } $i2e5aa867ea7c6f8ed9ffffe56b63b837364669dd = 'ownnumbersender'; } else { $i2e5aa867ea7c6f8ed9ffffe56b63b837364669dd = 'textsender'; } if ($ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec->displayCode !== true && !$ia1a238c1f12f3901520c7ca55efa646e471f7f6e->getMessage()) { try { $i5b2de9a29c087ac444f7af969b9863250e38aa27 = $i91f38bff7110fc85a77a8fd1a2cbfe902aa46e9e->create('Topefekt\Magesms\Model\\'.ucfirst($i2e5aa867ea7c6f8ed9ffffe56b63b837364669dd))->getCollection() ->addFieldToFilter('val', $i1b3f50fe6674f47cc7c1967f93ff153879178f04)->getFirstItem(); $i0a2378e8d343fdb890a9c568b07c541a35a12341 = $i91f38bff7110fc85a77a8fd1a2cbfe902aa46e9e->create('Topefekt\Magesms\Model\\'.ucfirst($i2e5aa867ea7c6f8ed9ffffe56b63b837364669dd))->load($i5b2de9a29c087ac444f7af969b9863250e38aa27->getId())->setVal($i1b3f50fe6674f47cc7c1967f93ff153879178f04); $i75cfaf6baf7d451ab67af9aeef048aecfea24a82->addObject($i0a2378e8d343fdb890a9c568b07c541a35a12341); $i75cfaf6baf7d451ab67af9aeef048aecfea24a82->save(); $this->getSession()->unsRoutes(); if ($i2e5aa867ea7c6f8ed9ffffe56b63b837364669dd === 'textsender') { $this->getSession()->setRouteSuccess(__('Text sender ID for ').$ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec->getAreaText().__(' was saved.')); } else { $this->getSession()->setRouteSuccess(__('Own number sender ID for ').$ie8b7b1b62dc29a284d794c9f11a8ee2ea7472eec->getAreaText().__(' was saved.')); } } catch (\Exception $i8c174347956f0a76258a09557543e84f88beb4a0) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setMessage($i8c174347956f0a76258a09557543e84f88beb4a0->getMessage()); } } if ($ia1a238c1f12f3901520c7ca55efa646e471f7f6e->getMessage()) $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(true); return $this->resultJsonFactory->create()->setData($ia1a238c1f12f3901520c7ca55efa646e471f7f6e); } }