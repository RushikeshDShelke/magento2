<?php
/**
 * Mage SMS - SMS notification & SMS marketing
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the BSD 3-Clause License
 * It is available through the world-wide-web at this URL:
 * http://opensource.org/licenses/BSD-3-Clause
 *
 * @category    TOPefekt
 * @package     TOPefekt_Magesms
 * @copyright   Copyright (c) 2012-2017 TOPefekt s.r.o. (http://www.mage-sms.com)
 * @license     http://opensource.org/licenses/BSD-3-Clause
 */
 namespace Topefekt\Magesms\Controller\Adminhtml\Marketing; use Magento\Framework\DataObject; class Filter extends \Topefekt\Magesms\Controller\Adminhtml\Marketing { public function execute() { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e = new DataObject(); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(false); if (!$this->getRequest()->getPost()) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(true); return $this->resultJsonFactory->create()->setData($ia1a238c1f12f3901520c7ca55efa646e471f7f6e); } $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setType('marketing'); $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2 = $this->getRequest(); if ($i1507c94b68f51b22087227858337782550edf618 = $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('action')) { try { switch ($i1507c94b68f51b22087227858337782550edf618) { case 'save': $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setHtml($this->_popup()); break; case 'load': $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setHtml($this->_popup(false)); break; case 'saveFilter': if ($this->getRequest()->isPost()) { $this->prepareFilters(); $iba20acc78644ac0e9cd48ea35d8ad03b058f6b5a = $this->_filterFactory->create(); $iba20acc78644ac0e9cd48ea35d8ad03b058f6b5a->setData([ 'name' => $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('saveName'), 'filter' => $this->_filtersCollection->toSerialize(), 'date' => date('Y-m-d H:i:s'), ]); $iba20acc78644ac0e9cd48ea35d8ad03b058f6b5a->save(); } break; case 'remove': if ($i7d411c0cc32cdb65ec82b9e8d79aa996946f5538 = $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('id')) { $iba20acc78644ac0e9cd48ea35d8ad03b058f6b5a = $this->_filterFactory->create(); $iba20acc78644ac0e9cd48ea35d8ad03b058f6b5a->load($i7d411c0cc32cdb65ec82b9e8d79aa996946f5538); $iba20acc78644ac0e9cd48ea35d8ad03b058f6b5a->delete(); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setHtml($this->_popup(false)); } break; case 'restore': if ($i7d411c0cc32cdb65ec82b9e8d79aa996946f5538 = $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('id')) { $iba20acc78644ac0e9cd48ea35d8ad03b058f6b5a = $this->_filterFactory->create(); if ($iba20acc78644ac0e9cd48ea35d8ad03b058f6b5a->load($i7d411c0cc32cdb65ec82b9e8d79aa996946f5538)) { $i2d8fb6b6f17ec9aa17899ea311cc26bc493cd9a2 = $this->_filtersCollection;; $i2d8fb6b6f17ec9aa17899ea311cc26bc493cd9a2->fromSerialize($iba20acc78644ac0e9cd48ea35d8ad03b058f6b5a->getFilter()); $this->prepareFilters(); $i21e55df616c305955791876c1eb4da83448beba2 = $this->_getBlockCustomer(); $i9e86252a333eb6c832bb895a8d1690c48b2ed3fd = $this->_getBlockDeleted(); $i1791b2d1f89bb2bd83b34046f59125af207713db = $this->_view->getLayout()->createBlock(\Topefekt\Magesms\Block\Adminhtml\Marketing\Filter::class); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setHtml( array( 'appliedFilters' => $i1791b2d1f89bb2bd83b34046f59125af207713db->getHtmlFilters(), 'customers' => $i21e55df616c305955791876c1eb4da83448beba2->toHtml(), 'deleted' => $i9e86252a333eb6c832bb895a8d1690c48b2ed3fd->toHtml(), 'count' => $this->_collection->count() )); } } break; case 'loadFilter': if ($i2bd9743336318d0e14be0600c9129730279505dd = $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('name')) { if ($iba20acc78644ac0e9cd48ea35d8ad03b058f6b5a = $this->_objectManager->create('Topefekt\\Magesms\\Model\\Marketing\\Filter\\'.ucfirst($i2bd9743336318d0e14be0600c9129730279505dd))) { $i1791b2d1f89bb2bd83b34046f59125af207713db = $this->_objectManager->create(\Magento\Framework\Data\Form::class); $id82aaf2f437652c4b6efbd55703199f614e8e516 = ''; switch ($iba20acc78644ac0e9cd48ea35d8ad03b058f6b5a->filter['type']) { case 'select': $i1791b2d1f89bb2bd83b34046f59125af207713db->addField('filter', 'select', [ 'name' => 'filter', 'values' => $iba20acc78644ac0e9cd48ea35d8ad03b058f6b5a->getValues(), ]); break; case 'input': $i1791b2d1f89bb2bd83b34046f59125af207713db->addField('filter', 'text', [ 'name' => 'filter', ]); break; case 'datetime': $i8114d84b871449f246242a4433e364f848daff0c = []; $i03474abc9cad4f5c29a2f0bca70a29051a128bc9 = "require(['jquery', 'mage/calendar'], function($) {
											$('%s').trigger('contentUpdated');
										});"; $i25a96aeb1dec798a01e094f736f8d291a0266aeb = $this->_timezone->getDateFormat( \IntlDateFormatter::MEDIUM ); $i53ddb2282ac3aca0d44abe35abcf69959ed66574 = $i1791b2d1f89bb2bd83b34046f59125af207713db->addField('filter1', 'date', [ 'name' => 'filter[]', 'value' => $this->_timezone->date(), 'date_format' => $i25a96aeb1dec798a01e094f736f8d291a0266aeb, ]); $i1791b2d1f89bb2bd83b34046f59125af207713db->addField('filter1time', 'time', [ 'name' => 'filter[]', ]); $i1791b2d1f89bb2bd83b34046f59125af207713db->addField('note', 'note', [ 'text' => __('to: '), ]); $i1791b2d1f89bb2bd83b34046f59125af207713db->addField('filter2', 'date', [ 'name' => 'filter[]', 'value' => $this->_timezone->date(), 'date_format' => $i25a96aeb1dec798a01e094f736f8d291a0266aeb, ]); $i1791b2d1f89bb2bd83b34046f59125af207713db->addField('filter2time', 'time', [ 'name' => 'filter[]', 'value' => '23,59,59', ]); $i8114d84b871449f246242a4433e364f848daff0c[] = sprintf($i03474abc9cad4f5c29a2f0bca70a29051a128bc9, '#filter1'); $i8114d84b871449f246242a4433e364f848daff0c[] = sprintf($i03474abc9cad4f5c29a2f0bca70a29051a128bc9, '#filter2'); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setJs($i8114d84b871449f246242a4433e364f848daff0c); break; case 'date': $i8114d84b871449f246242a4433e364f848daff0c = []; $i03474abc9cad4f5c29a2f0bca70a29051a128bc9 = "require(['jquery', 'mage/calendar'], function($) {
											$('%s').trigger('contentUpdated');
										});"; $i25a96aeb1dec798a01e094f736f8d291a0266aeb = $this->_timezone->getDateFormat( \IntlDateFormatter::MEDIUM ); $i1791b2d1f89bb2bd83b34046f59125af207713db->addField('filter1', 'date', [ 'name' => 'filter[]', 'date_format' => $i25a96aeb1dec798a01e094f736f8d291a0266aeb, 'value' => $this->_timezone->date(), ]); $i1791b2d1f89bb2bd83b34046f59125af207713db->addField('note', 'note', [ 'text' => __('to: '), ]); $i1791b2d1f89bb2bd83b34046f59125af207713db->addField('filter2', 'date', [ 'name' => 'filter[]', 'date_format' => $i25a96aeb1dec798a01e094f736f8d291a0266aeb, 'value' => $this->_timezone->date(), ]); $i8114d84b871449f246242a4433e364f848daff0c[] = sprintf($i03474abc9cad4f5c29a2f0bca70a29051a128bc9, '#filter1'); $i8114d84b871449f246242a4433e364f848daff0c[] = sprintf($i03474abc9cad4f5c29a2f0bca70a29051a128bc9, '#filter2'); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setJs($i8114d84b871449f246242a4433e364f848daff0c); break; case 'birthdayall': $i1791b2d1f89bb2bd83b34046f59125af207713db->addField('note1', 'note', [ 'text' => __('day').': ', ]); $i1791b2d1f89bb2bd83b34046f59125af207713db->addField('filter1', 'select', [ 'name' => 'filter[]', 'values' => array_combine(range(1, 31), range(1, 31)), ]); $i1791b2d1f89bb2bd83b34046f59125af207713db->addField('note2', 'note', [ 'text' => __('month').': ', ]); $i1791b2d1f89bb2bd83b34046f59125af207713db->addField('filter2', 'select', [ 'name' => 'filter[]', 'values' => array_combine(range(1, 12), range(1, 12)), ]); break; case 'number': $i1791b2d1f89bb2bd83b34046f59125af207713db->addField('filter1', 'select', [ 'name' => 'filter[]', 'values' => ['0' => '<', '1' => '>', '2' => '=', '3' => 'â‰ '], 'style' => 'min-width:auto;width:80px' ]); $i1791b2d1f89bb2bd83b34046f59125af207713db->addField('filter2', 'text', [ 'name' => 'filter[]', ]); break; } $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setHtml($i1791b2d1f89bb2bd83b34046f59125af207713db->getHtml().($id82aaf2f437652c4b6efbd55703199f614e8e516?:'')); } } break; case 'applyFilter': $if2eee0665f163a28f4adcfe84e3fc666bf1bcd89 = $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('filter'); if (is_array($if2eee0665f163a28f4adcfe84e3fc666bf1bcd89) && count($if2eee0665f163a28f4adcfe84e3fc666bf1bcd89) == 1) $if2eee0665f163a28f4adcfe84e3fc666bf1bcd89 = $if2eee0665f163a28f4adcfe84e3fc666bf1bcd89[0]; if (($i2bd9743336318d0e14be0600c9129730279505dd = $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('name')) && $if2eee0665f163a28f4adcfe84e3fc666bf1bcd89 !== '') { $i2d8fb6b6f17ec9aa17899ea311cc26bc493cd9a2 = $this->_filtersCollection; $i2d8fb6b6f17ec9aa17899ea311cc26bc493cd9a2->addApplyFilter($i2bd9743336318d0e14be0600c9129730279505dd, $if2eee0665f163a28f4adcfe84e3fc666bf1bcd89); $this->prepareFilters(); $i21e55df616c305955791876c1eb4da83448beba2 = $this->_getBlockCustomer(); $i1791b2d1f89bb2bd83b34046f59125af207713db = $this->_view->getLayout()->createBlock(\Topefekt\Magesms\Block\Adminhtml\Marketing\Filter::class); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setHtml( [ 'appliedFilters' => $i1791b2d1f89bb2bd83b34046f59125af207713db->getHtmlFilters(), 'customers' => $i21e55df616c305955791876c1eb4da83448beba2->toHtml(), 'count' => $this->_collection->count() ]); } break; case 'removeFilter': $i7d411c0cc32cdb65ec82b9e8d79aa996946f5538 = $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('id'); if (is_numeric($i7d411c0cc32cdb65ec82b9e8d79aa996946f5538)) { $i2d8fb6b6f17ec9aa17899ea311cc26bc493cd9a2 = $this->_filtersCollection;; $i2d8fb6b6f17ec9aa17899ea311cc26bc493cd9a2->removeFilter($i7d411c0cc32cdb65ec82b9e8d79aa996946f5538); $this->prepareFilters(); $i21e55df616c305955791876c1eb4da83448beba2 = $this->_getBlockCustomer(); $i9e86252a333eb6c832bb895a8d1690c48b2ed3fd = $this->_getBlockDeleted(); $i1791b2d1f89bb2bd83b34046f59125af207713db = $this->_view->getLayout()->createBlock(\Topefekt\Magesms\Block\Adminhtml\Marketing\Filter::class); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setHtml( [ 'appliedFilters' => $i1791b2d1f89bb2bd83b34046f59125af207713db->getHtmlFilters(), 'customers' => $i21e55df616c305955791876c1eb4da83448beba2->toHtml(), 'deleted' => $i9e86252a333eb6c832bb895a8d1690c48b2ed3fd->toHtml(), 'count' => $this->_collection->count() ]); } break; case 'listCustomers': if ($i47b2a41e4081b6f8d8381f411087dcd7042bfb53 = $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('letter')) { $i2d8fb6b6f17ec9aa17899ea311cc26bc493cd9a2 = $this->_filtersCollection; $this->prepareFilters(); $this->_collection->addFieldToFilter('lastname', ['like' => $i47b2a41e4081b6f8d8381f411087dcd7042bfb53.'%']); $i21e55df616c305955791876c1eb4da83448beba2 = $this->getBlockCustomer(); $i21e55df616c305955791876c1eb4da83448beba2->setCollection($this->_collection); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setHtml($i21e55df616c305955791876c1eb4da83448beba2->toHtml()); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setType('customer'); } break; case 'removeCustomer': if ($i7d411c0cc32cdb65ec82b9e8d79aa996946f5538 = $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('id')) { $i2d8fb6b6f17ec9aa17899ea311cc26bc493cd9a2 = $this->_filtersCollection; $i2d8fb6b6f17ec9aa17899ea311cc26bc493cd9a2->addRemoveCustomer($i7d411c0cc32cdb65ec82b9e8d79aa996946f5538); $this->prepareFilters(); $ib1285cda66d7403b4e0132565b5359295c62d58c = clone $this->_collection; $i21e55df616c305955791876c1eb4da83448beba2 = $this->_getBlockCustomer(); $i9e86252a333eb6c832bb895a8d1690c48b2ed3fd = $this->_getBlockDeleted(); $id82aaf2f437652c4b6efbd55703199f614e8e516 = [ 'customers' => $i21e55df616c305955791876c1eb4da83448beba2->toHtml(), 'deleted' => $i9e86252a333eb6c832bb895a8d1690c48b2ed3fd->toHtml(), 'count' => $this->_collection->count() ]; if ($i47b2a41e4081b6f8d8381f411087dcd7042bfb53 = $i628d8ebfdcd1b4d13c7bb90cffb2f53678d994d2->getParam('letter')) { $ib1285cda66d7403b4e0132565b5359295c62d58c->addFieldToFilter('lastname', ['like' => $i47b2a41e4081b6f8d8381f411087dcd7042bfb53.'%']); $i2ca8461421e371a2dc8ff5b5c9a248f5fb0a6dbc = $this->getBlockCustomer(); $i2ca8461421e371a2dc8ff5b5c9a248f5fb0a6dbc->setCollection($ib1285cda66d7403b4e0132565b5359295c62d58c); $id82aaf2f437652c4b6efbd55703199f614e8e516['customer_letter'] = $i2ca8461421e371a2dc8ff5b5c9a248f5fb0a6dbc->toHtml(); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setType('customer'); } $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setHtml($id82aaf2f437652c4b6efbd55703199f614e8e516); } break; case 'reset': $i2d8fb6b6f17ec9aa17899ea311cc26bc493cd9a2 = $this->_filtersCollection;; $i2d8fb6b6f17ec9aa17899ea311cc26bc493cd9a2->resetFilter(); $this->prepareFilters(); $i21e55df616c305955791876c1eb4da83448beba2 = $this->_getBlockCustomer(); $i9e86252a333eb6c832bb895a8d1690c48b2ed3fd = $this->_getBlockDeleted(); $i1791b2d1f89bb2bd83b34046f59125af207713db = $this->_view->getLayout()->createBlock(\Topefekt\Magesms\Block\Adminhtml\Marketing\Filter::class); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setHtml( [ 'appliedFilters' => $i1791b2d1f89bb2bd83b34046f59125af207713db->getHtmlFilters(), 'customers' => $i21e55df616c305955791876c1eb4da83448beba2->toHtml(), 'deleted' => $i9e86252a333eb6c832bb895a8d1690c48b2ed3fd->toHtml(), 'count' => $this->_collection->count() ]); break; } } catch (\Exception $i8c174347956f0a76258a09557543e84f88beb4a0) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(true); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setMessage($i8c174347956f0a76258a09557543e84f88beb4a0->getMessage()); } return $this->resultJsonFactory->create()->setData($ia1a238c1f12f3901520c7ca55efa646e471f7f6e); } } protected function _getBlockCustomer() { $i8ee45e0018a32fb1a855b82624506e35789cc4d2 = $this->_view->getLayout()->createBlock(\Topefekt\Magesms\Block\Adminhtml\Marketing\Customer::class, 'magesms.marketing.index-customer'); $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setCollection($this->_collection); $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setTitle(__('Customers found: ')); $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setId('customer'); return $i8ee45e0018a32fb1a855b82624506e35789cc4d2; } protected function _getBlockDeleted() { $i8ee45e0018a32fb1a855b82624506e35789cc4d2 = $this->_view->getLayout()->createBlock(\Topefekt\Magesms\Block\Adminhtml\Marketing\CustomerDeleted::class, 'magesms.marketing.index-customer.deleted'); $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setDeleteCustomer(true); $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setTitle(__('Removed Customers: ')); $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setId('customerdeleted'); $iff7e46827cbb6547116c592bf800f4687428abf9 = $this->getMageHelper()->getCustomerCollection(); $iff7e46827cbb6547116c592bf800f4687428abf9->addFieldToFilter('entity_id', ['in' => $this->_filtersCollection->getCache()->getCustomers()->getIds()]); foreach($iff7e46827cbb6547116c592bf800f4687428abf9 as $i705fa7c9639d497e1179d7d5691c212668a8c9c8) { $i705fa7c9639d497e1179d7d5691c212668a8c9c8->setDetailUrl($this->getUrl('/customer/index/edit', ['id' => $i705fa7c9639d497e1179d7d5691c212668a8c9c8->getId()])); $i705fa7c9639d497e1179d7d5691c212668a8c9c8->setRemoveUrl($this->getUrl('*/*/filter', ['action' => 'removeCustomer', 'id' => $i705fa7c9639d497e1179d7d5691c212668a8c9c8->getId()])); } $i8ee45e0018a32fb1a855b82624506e35789cc4d2->setCollection($iff7e46827cbb6547116c592bf800f4687428abf9); return $i8ee45e0018a32fb1a855b82624506e35789cc4d2; } } 