<?php
/**
 * Mage SMS - SMS notification & SMS marketing
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the BSD 3-Clause License
 * It is available through the world-wide-web at this URL:
 * http://opensource.org/licenses/BSD-3-Clause
 *
 * @category    TOPefekt
 * @package     TOPefekt_Magesms
 * @copyright   Copyright (c) 2012-2017 TOPefekt s.r.o. (http://www.mage-sms.com)
 * @license     http://opensource.org/licenses/BSD-3-Clause
 */
 namespace Topefekt\Magesms\Controller\Adminhtml\Profile; use Magento\Backend\App\Action\Context; use Magento\Framework\DataObject; use Magento\Framework\Registry; use Magento\Framework\View\Result\PageFactory; use Magento\Framework\Controller\Result\JsonFactory; use Topefekt\Magesms\Helper\Data; use Topefekt\Magesms\Model\Api; use Topefekt\Magesms\Model\Smsprofile; class Validate extends \Topefekt\Magesms\Controller\Adminhtml\Action { protected $resultJsonFactory; protected $frontUrlModel; public function __construct(Context $i31cc913adc2717e2346d503153c97449098831aa, PageFactory $i3f1db03e4dfdd28ff5ba1a1f709c3a2e135b99b1, Smsprofile $i6abff7c4dab2aa28578ae1dc49699ba6b1d18c18, Api $i451f679eaafeecb81387b150019f0d9e0fa83d16, Data $i0d09b2a4f282150bf47b02f9f3d82586fe313844, Registry $ie9fe5cdc9fc7093987f4d41ad4cae3554e64e17b, JsonFactory $i9a280ebe4bf63f298222a5d64da69db4e648d487) { $this->resultJsonFactory = $i9a280ebe4bf63f298222a5d64da69db4e648d487; parent::__construct($i31cc913adc2717e2346d503153c97449098831aa, $i3f1db03e4dfdd28ff5ba1a1f709c3a2e135b99b1, $i6abff7c4dab2aa28578ae1dc49699ba6b1d18c18, $i451f679eaafeecb81387b150019f0d9e0fa83d16, $i0d09b2a4f282150bf47b02f9f3d82586fe313844, $ie9fe5cdc9fc7093987f4d41ad4cae3554e64e17b); } public function execute() { if (!$this->getRequest()->getPost()) return; $ia1a238c1f12f3901520c7ca55efa646e471f7f6e = new DataObject(); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(false); if ($this->getRequest()->getPost()) { $iacbd1c78463510856e506611fe14b5e1173581a6 = $this->getRequest(); $this->profile->user->setEmail($iacbd1c78463510856e506611fe14b5e1173581a6->getPost('email', '')); $this->profile->user->setAddressstreet($iacbd1c78463510856e506611fe14b5e1173581a6->getPost('addressstreet', '')); $this->profile->user->setAddresszip($iacbd1c78463510856e506611fe14b5e1173581a6->getPost('addresszip', '')); $this->profile->user->setAddresscity($iacbd1c78463510856e506611fe14b5e1173581a6->getPost('addresscity', '')); $this->profile->user->setCountry($iacbd1c78463510856e506611fe14b5e1173581a6->getPost('country', '')); $this->profile->user->setRegtype($iacbd1c78463510856e506611fe14b5e1173581a6->getPost('regtype', '')); $this->profile->user->setFirstname($iacbd1c78463510856e506611fe14b5e1173581a6->getPost('firstname', '')); $this->profile->user->setLastname($iacbd1c78463510856e506611fe14b5e1173581a6->getPost('lastname', '')); if ($this->profile->user->getRegtype() == 'firm') { $this->profile->user->setCompanyname($iacbd1c78463510856e506611fe14b5e1173581a6->getPost('companyname', '')); $this->profile->user->setCompanyid($iacbd1c78463510856e506611fe14b5e1173581a6->getPost('companyid', '')); $this->profile->user->setCompanyvat($iacbd1c78463510856e506611fe14b5e1173581a6->getPost('companyvat', '')); } else { $this->profile->user->setCompanyname(''); $this->profile->user->setCompanyid(''); $this->profile->user->setCompanyvat(''); } $this->profile->user->setData('agree', $iacbd1c78463510856e506611fe14b5e1173581a6->getPost('agree', 0)); $ibdd27a8dd714410289189d318feb96fe6ed8e07f = $this->profile->user->validate(); if (is_array($ibdd27a8dd714410289189d318feb96fe6ed8e07f) && count($ibdd27a8dd714410289189d318feb96fe6ed8e07f)) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(true); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setMessage(implode(" ", $ibdd27a8dd714410289189d318feb96fe6ed8e07f)); return $this->resultJsonFactory->create()->setData($ia1a238c1f12f3901520c7ca55efa646e471f7f6e); } if ($this->profile->user->getUser()) { $ia61712c27ea241bd7a543dc2b02ea572274d0322 = base64_decode("YWN0aW9uPWVkaXQmdXNlcm5hbWU9").urlencode($this->profile->user->getUser()). base64_decode("JnBhc3N3b3JkPQ==").urlencode($this->profile->user->getPasswd()); } else { $ie955ee51cd0c7df255b696081bc48b422055d462 = $this->_mageHelper->getConfig('default/referer'); if (!$ie955ee51cd0c7df255b696081bc48b422055d462) { $ie955ee51cd0c7df255b696081bc48b422055d462 = $iacbd1c78463510856e506611fe14b5e1173581a6->getPost('refererid', ''); } $ia61712c27ea241bd7a543dc2b02ea572274d0322 = 'action=register&refererid='.urlencode($ie955ee51cd0c7df255b696081bc48b422055d462); } $ia61712c27ea241bd7a543dc2b02ea572274d0322 .= base64_decode("JmVtYWlsPQ==").urlencode($this->profile->user->getEmail()). base64_decode("JmptZW5vPQ==").urlencode($this->profile->user->getCompanyname()). base64_decode("Jmtvc29iYT0=").urlencode($this->profile->user->getFirstname()). base64_decode("JmtwcmlqbWVuaT0=").urlencode($this->profile->user->getLastname()). "&adresa_ulice=".urlencode($this->profile->user->getAddressstreet()). "&adresa_mesto=".urlencode($this->profile->user->getAddresscity()). "&adresa_PSC=".urlencode($this->profile->user->getAddresszip()). "&country0=".urlencode($this->profile->user->getCountry()). base64_decode("JklDTz0=").urlencode($this->profile->user->getCompanyid()). base64_decode("JkRJQz0=").urlencode($this->profile->user->getCompanyvat()); $i55dd4e7042a1f9031b84f07f04c37165ce3d0720 = $this->_api->serverPost($ia61712c27ea241bd7a543dc2b02ea572274d0322); if ($i55dd4e7042a1f9031b84f07f04c37165ce3d0720['errno'] != 1 || empty($i55dd4e7042a1f9031b84f07f04c37165ce3d0720['data'])) { if (is_array($ibdd27a8dd714410289189d318feb96fe6ed8e07f) && count($ibdd27a8dd714410289189d318feb96fe6ed8e07f)) { $ibdd27a8dd714410289189d318feb96fe6ed8e07f[] = __($i55dd4e7042a1f9031b84f07f04c37165ce3d0720['error']); } else { $ibdd27a8dd714410289189d318feb96fe6ed8e07f = [__($i55dd4e7042a1f9031b84f07f04c37165ce3d0720['error'])]; } } elseif (!$this->profile->user->getUser() && $i55dd4e7042a1f9031b84f07f04c37165ce3d0720['errno'] == 1) { $this->profile->user->setUser($i55dd4e7042a1f9031b84f07f04c37165ce3d0720['data'][0]); $this->profile->user->setPasswd($i55dd4e7042a1f9031b84f07f04c37165ce3d0720['data'][1]); } if (is_array($ibdd27a8dd714410289189d318feb96fe6ed8e07f) && count($ibdd27a8dd714410289189d318feb96fe6ed8e07f)) { $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setError(true); $ia1a238c1f12f3901520c7ca55efa646e471f7f6e->setMessage(implode(' ', $ibdd27a8dd714410289189d318feb96fe6ed8e07f)); return $this->resultJsonFactory->create()->setJsonData($ia1a238c1f12f3901520c7ca55efa646e471f7f6e->toJson()); } else { $i5bf407a3ecf35ff195a9c7e8f546cfc606253fad = $this->profile->user->getId(); $this->profile->user->save(); if ($i5bf407a3ecf35ff195a9c7e8f546cfc606253fad) $this->messageManager->addSuccessMessage(__('Account was changed.')); else { $this->messageManager->addSuccessMessage(__('Account was created.')); $ie2d3c964f264968835c26fc02ee0d5f0820fe0ce = $this->_url->getBaseUrl().'magesms/delivery'; $ia61712c27ea241bd7a543dc2b02ea572274d0322 = base64_decode("YWN0aW9uPWVkaXQyJnVzZXJuYW1lPQ==").urlencode($this->profile->user->getUser()). base64_decode("JnBhc3N3b3JkPQ==").urlencode($this->profile->user->getPasswd()). "&shop_domain=".urlencode($ie2d3c964f264968835c26fc02ee0d5f0820fe0ce); $i55dd4e7042a1f9031b84f07f04c37165ce3d0720 = $this->_api->serverPost($ia61712c27ea241bd7a543dc2b02ea572274d0322); if ($i55dd4e7042a1f9031b84f07f04c37165ce3d0720['errno'] != 99 || !empty($i55dd4e7042a1f9031b84f07f04c37165ce3d0720['data'])) { if ($i55dd4e7042a1f9031b84f07f04c37165ce3d0720['errno'] == 1 || $i55dd4e7042a1f9031b84f07f04c37165ce3d0720['errno'] == 5) $this->profile->user->setUrlreports(1)->save(); } } } } return $this->resultJsonFactory->create()->setData($ia1a238c1f12f3901520c7ca55efa646e471f7f6e); } protected function _isAllowed() { return $this->_authorization->isAllowed('Topefekt_Magesms::magesms_profile'); } } 