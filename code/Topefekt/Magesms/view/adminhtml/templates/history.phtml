<?php
/**
 * Mage SMS - SMS notification & SMS marketing
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the BSD 3-Clause License
 * It is available through the world-wide-web at this URL:
 * http://opensource.org/licenses/BSD-3-Clause
 *
 * @category    TOPefekt
 * @package     TOPefekt_Magesms
 * @copyright   Copyright (c) 2012-2017 TOPefekt s.r.o. (http://www.mage-sms.com)
 * @license     http://opensource.org/licenses/BSD-3-Clause
 */
?><?php $user = $block->profile->user; $lang = $block->profile->lang; $type = [ 1 => __(' admin sms'), 2 => __(' customer sms'), 3 => __(' marketing sms'), 4 => __(' simple sms') ]; $history = $block->getCollection(); ?><div style="float: right;"><form action="<?php echo $block->getUrl('*/*/exportcsv') ?>" method="post"><?php echo $block->getBlockHtml('formkey') ?><button id="submit" name="submit" title="<?php echo $block->escapeHtml(__('Export history')); ?>" type="submit" class="" role="button" aria-disabled="false"><span class="ui-button-text"><span><?php echo $block->escapeHtml(__('Export history')); ?></span></span></button></form></div><div style="float: right;margin-right: 10px;"><form action="<?php echo $block->getUrl('*/*/deleteall') ?>" method="post"><?php echo $block->getBlockHtml('formkey') ?><button id="submit" name="submit" title="<?php echo $block->escapeHtml(__('Delete history')); ?>" type="submit" onclick="return confirm('<?php echo __('Are you sure to delete SMS history?'); ?>');" class="" role="button" aria-disabled="false"><span class="ui-button-text"><span><?php echo $block->escapeHtml(__('Delete history')); ?></span></span></button></form></div><p><?php echo __('History of sent SMS from SMS module.'); ?></p><div id="magesms"><div class="entry-edit"><div class="entry-edit-head"><h4 class="icon-head fieldset-legend head-account"><img src="<?php echo $block->getViewFileUrl('Topefekt_Magesms::images/AdminTools.gif'); ?>" alt="" /> <?php echo __('SMS History'); ?></h4></div><fieldset class="fieldset grid"><form id="magesms_filter" action="<?php echo $block->getUrl('*/*/') ?>" method="get"><?php echo $block->getBlockHtml('formkey') ?><?php if ($history->count()) $rokmin = substr($history->getFirstItem()->getDate(), 0, 4); else $rokmin = date('Y'); $roky = array(); for(; $rokmin <= date('Y'); $rokmin++) $roky[] = $rokmin; ?><div class="margin-form" style="text-align: center"><select name="rok" id="rok" class="admin__control-select"><option value=""><?php echo __('year'); ?></option><?php foreach( $roky as $rok ): ?><option value="<?php echo $rok; ?>" <?php echo $rok == $block->getRequest()->getParam('rok', date('Y')) ? 'selected' : ''; ?>><?php echo $rok; ?></option><?php endforeach; ?></select><select name="mesic" id="mesic" class="admin__control-select"><option value=""><?php echo __('month'); ?></option><?php for( $mesic=1; $mesic<=12; $mesic++ ): ?><option value="<?php echo $mesic; ?>" <?php echo $mesic == $block->getRequest()->getParam('mesic') ? 'selected' : ''; ?>><?php echo $mesic; ?></option><?php endfor; ?></select><select name="den" id="den" class="admin__control-select"><option value=""><?php echo __('day'); ?></option><?php for( $den=1; $den<=31; $den++ ): ?><option value="<?php echo $den; ?>" <?php echo $den == $block->getRequest()->getParam('den') ? 'selected' : ''; ?>><?php echo sprintf('%02d', $den); ?></option><?php endfor; ?></select><select name="status" id="status" class="admin__control-select"><option value=""><?php echo __('Status'); ?></option><?php foreach( $block->getSms()->status() as $id=>$stat ): ?><option value="<?php echo $id; ?>" <?php echo $id == $block->getRequest()->getParam('status') ? 'selected' : ''; ?>><?php echo $stat->getName(); ?></option><?php endforeach; ?></select><input type="hidden" name="eshopsms1" value="0" />&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="eshopsms1" id="eshopsms1" class="admin__control-checkbox" value="1" <?php echo $block->getRequest()->getParam('eshopsms1') == null || $block->getRequest()->getParam('eshopsms1') == 1 ? 'checked' : ''; ?> /><label for="eshopsms1"><?php echo __(' admin sms'); ?></label><input type="hidden" name="eshopsms" value="0" />&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="eshopsms" id="eshopsms" class="admin__control-checkbox" value="1" <?php echo $block->getRequest()->getParam('eshopsms') == null || $block->getRequest()->getParam('eshopsms') == 1 ? 'checked' : ''; ?> /><label for="eshopsms"><?php echo __(' customer sms'); ?></label><input type="hidden" name="bulksms" value="0" />&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="bulksms" id="bulksms" class="admin__control-checkbox" value="1" <?php echo $block->getRequest()->getParam('bulksms') == null || $block->getRequest()->getParam('bulksms') == 1 ? 'checked' : ''; ?> /><label for="bulksms"><?php echo __(' marketing sms'); ?></label><input type="hidden" name="bulksms2" value="0" />&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" name="bulksms2" id="bulksms2" class="admin__control-checkbox" value="1" <?php echo $block->getRequest()->getParam('bulksms2') == null || $block->getRequest()->getParam('bulksms2') == 1 ? 'checked' : ''; ?> /><label for="bulksms2"><?php echo __(' simple sms'); ?></label>&nbsp;&nbsp;&nbsp;&nbsp;<button id="submit" name="submit" title="<?php echo $block->escapeHtml(__('Show')); ?>" type="submit" class="primary" role="button" aria-disabled="false"><span class="ui-button-text"><span><?php echo $block->escapeHtml(__('Show')); ?></span></span></button></div></form></fieldset></div><?php if ($history->getSize()): ?><div class="entry-edit"><div class="entry-edit-head"><h4 class="icon-head fieldset-legend head-account"><img src="<?php echo $block->getViewFileUrl('Topefekt_Magesms::images/AdminCatalog.gif'); ?>" alt="" /><?php echo __('Search results ').' '.$block->getFrom().' - '.$block->getTo().__(' of ').$history->getSize().' '.__('SMS'); ?></h4></div><fieldset class="fieldset grid"><table class="actions"><tr><td class="pager"><?php echo __('Page') ?><?php $_curPage = $history->getCurPage() ?><?php $_lastPage = $history->getLastPageNumber() ?><?php if($_curPage>1): ?><a href="<?php echo $block->getUrl('*/*/', $block->getRequest()->getParams()+ ['page' => $_curPage-1]); ?>" title="<?php echo __('Previous') ?>"><img src="<?php echo $block->getViewFileUrl('Topefekt_Magesms::images/pager_arrow_left.gif') ?>" alt="Go to Previous page" class="arrow"/></a><?php else: ?><img src="<?php echo $block->getViewFileUrl('Topefekt_Magesms::images/pager_arrow_left_off.gif') ?>" alt="Go to Previous page" class="arrow"/><?php endif; ?><input type="text" name="curPage" readonly value="<?php echo $_curPage ?>" class="input-text page admin__control-text" size="3" /><?php if($_curPage < $_lastPage): ?><a href="<?php echo $block->getUrl('*/*/', $block->getRequest()->getParams()+ ['page' => $_curPage+1]); ?>" title="<?php echo __('Next') ?>"><img src="<?php echo $block->getViewFileUrl('Topefekt_Magesms::images/pager_arrow_right.gif') ?>" alt="Go to Next page" class="arrow"/></a><?php else: ?><img src="<?php echo $block->getViewFileUrl('Topefekt_Magesms::images/pager_arrow_right_off.gif') ?>" alt="Go to Previous page" class="arrow"/><?php endif; ?></td></tr></table><table class="data-grid"><tr class="headings"><th><?php echo __('Number'); ?></th><th><?php echo __('Recipient'); ?></th><th><?php echo __('SMS subject'); ?></th><th class="a-left"><?php echo __('Date'); ?></th><th><?php echo __('Type'); ?></th><th class="a-center"><?php echo __('Status'); ?></th></tr><?php $even = 1; foreach($history as $_obj): if ($even) $even = 0; else $even = 1;?><tr id="hist_<?php echo $_obj->getId(); ?>" class="hover <?php if ($even) echo 'even'?>"><td><span class="img"><img class="toggle" src="<?php echo $block->getViewFileUrl('Topefekt_Magesms::images/i_plus.gif'); ?>"></span><span class="img" style="display:none"><img class="toggle" src="<?php echo $block->getViewFileUrl('Topefekt_Magesms::images/i_minus.gif'); ?>"></span><?php echo $_obj->getNumber(); ?></td><td><?php if (0 && $_obj->getCustomerId()): ?><?php $customer = $block->loadCustomer($_obj->getCustomerId()); ?><?php if ($customer->getId()): ?><a href="<?php echo $block->getUrl('*/customer/edit', array('id' => $_obj->getCustomerId())); ?>" target="magesms_popup_customer" title="<?php echo __('Display customer detail'); ?>"><?php echo $customer->getFirstname(); ?> <?php echo $customer->getLastname(); ?></a><?php else: ?><?php echo $block->moreText($_obj->getRecipient(), 16, 25); ?><?php endif; ?><?php elseif ($_obj->getAdminId()): ?><?php $admin = $block->loadAdmins($_obj->getAdminId()); ?><?php if ($admin->getId()): ?><?php echo $admin->getName(); ?><?php else: ?><?php echo $block->moreText($_obj->getRecipient(), 16, 25); ?><?php endif; ?><?php else: ?><?php echo ($recipient = $block->moreText($_obj->getRecipient(), 16, 25)) ? $recipient: '-' ?><?php endif; ?></td><td><?php echo ($subject = $block->moreText($_obj->getSubject(), 19, 35)) ? $subject : '-'; ?></td><td><?php echo $_obj->getDate(); ?></td><td><?php echo $type[$_obj->getType()]; ?></td><td class="a-center"><img src="<?php echo $block->getViewFileUrl('Topefekt_Magesms::images/'.$block->getSms()->status($_obj->getStatus())->getIcon()); ?>" title="<?php echo $block->getSms()->status($_obj->getStatus())->getName().(($note=$_obj->getNote()) && ($_obj->getStatus() == \Topefekt\Magesms\Model\Sms::ERROR || $_obj->getStatus() == \Topefekt\Magesms\Model\Sms::SCHEDULED) ? " - $note" : '') ; ?>" /></td></tr><tr id="histd_<?php echo $_obj->getId(); ?>" class="<?php if ($even) echo 'even'?>" style="display:none"><td colspan="6"><b><?php echo __('Text:'); ?></b><br /><?php echo $_obj->getText(); ?><br /><br /><b><?php echo __('SMS price in credits:'); ?></b> <?php echo $_obj->getPrice(); ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?php if ($_obj->getPrice() > 0): ?><b><?php echo __('Credit balance:'); ?></b> <?php echo $_obj->getCredit(); ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?php endif; ?><b><?php echo __('Total SMS:'); ?></b> <?php echo $_obj->getTotal(); ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><?php echo __('Unicode:'); ?></b> <?php echo $_obj->getUnicode() ? __('yes') : __('no'); ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><?php echo __('senderID:'); ?></b><?php if ($_obj->getSender() && preg_match("/^([0-9])*$/", $_obj->getSender(), $matches)): ?>+<?php echo $_obj->getSender(); ?><?php elseif ($_obj->getSender()): ?><?php echo $_obj->getSender(); ?><?php else: ?><?php echo __('system number'); ?><?php endif; ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?php if ($_obj->getSmsid()): ?><br /><b><?php echo __('smsID:'); ?></b> <?php echo $_obj->getSmsid(); ?><?php endif; ?></td></tr><?php endforeach; ?></table><table class="actions"><tr><td class="pager"><?php echo __('Page') ?><?php $_curPage = $history->getCurPage() ?><?php $_lastPage = $history->getLastPageNumber() ?><?php if($_curPage>1): ?><a href="<?php echo $block->getUrl('*/*/', $block->getRequest()->getParams()+array('page' => $_curPage-1)); ?>" title="<?php echo __('Previous') ?>"><img src="<?php echo $block->getViewFileUrl('Topefekt_Magesms::images/pager_arrow_left.gif') ?>" alt="Go to Previous page" class="arrow"/></a><?php else: ?><img src="<?php echo $block->getViewFileUrl('Topefekt_Magesms::images/pager_arrow_left_off.gif') ?>" alt="Go to Previous page" class="arrow"/><?php endif; ?><input type="text" name="curPage" readonly value="<?php echo $_curPage ?>" class="input-text page admin__control-text" size="3" /><?php if($_curPage < $_lastPage): ?><a href="<?php echo $block->getUrl('*/*/', $block->getRequest()->getParams()+array('page' => $_curPage+1)); ?>" title="<?php echo __('Next') ?>"><img src="<?php echo $block->getViewFileUrl('Topefekt_Magesms::images/pager_arrow_right.gif') ?>" alt="Go to Next page" class="arrow"/></a><?php else: ?><img src="<?php echo $block->getViewFileUrl('Topefekt_Magesms::images/pager_arrow_right_off.gif') ?>" alt="Go to Previous page" class="arrow"/><?php endif; ?></td></tr></table></fieldset></div><script type="text/javascript">//<![CDATA[
require(['jquery',], function($) {$(document).ready(function () {var gridData = document.getElementById('magesms');var tr_array = gridData.getElementsByTagName('tr');for (var i=0, len=tr_array.length; i < len; i++) {if (tr_array[i].className.indexOf('hover') !== -1) {tr_array[i].onmouseover = function() {this.className = this.className + ' on-mouse';};tr_array[i].onmouseout = function() {this.className = this.className.replace(' on-mouse', '');};tr_array[i].onclick = function() {var arr = this.id.split('_');var next = document.getElementById('histd_'+arr[1]);if (next.style.display == 'none') {next.style.display = 'table-row';} else {next.style.display = 'none';}var img = this.getElementsByClassName('img');if (img[0].style.display == 'none') {img[0].style.display = 'inline';} else {img[0].style.display = 'none';}if (img[1].style.display == 'none') {img[1].style.display = 'inline';} else {img[1].style.display = 'none';}};}}});});
//]]></script><?php else: ?><div><?php echo __('Total SMS: 0'); ?></div><?php endif; ?></div>